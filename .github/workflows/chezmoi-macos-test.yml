name: macos-test
on: 
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
jobs:
  test:
      name: chezmoi test
      runs-on: macos-latest
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      steps:
        - name: Install chezmoi
          run: brew install chezmoi
        - name: Initialize chezmoi
          run: chezmoi init https://github.com/yutanpo1227/dotfiles.git
        - name: Apply chezmoi
          run: chezmoi apply
        - name: Add local bin to PATH
          run: echo "$HOME/.local/bin" >> "$GITHUB_PATH"
        - name: Verify commands on PATH
          run: |
            set -euo pipefail
            for cmd in chezmoi curl git zsh mise; do
              if ! command -v "$cmd" >/dev/null 2>&1; then
                echo "Missing command on PATH: $cmd" >&2
                exit 1
              fi
            done
            chezmoi --version
            curl --version
            git --version
            zsh --version
            mise --version
        - name: Verify all mise tools on PATH
          run: |
            set -euo pipefail
            eval "$("$HOME/.local/bin/mise" activate bash)"
            python3 - <<'PY'
            import os
            import shlex
            import subprocess
            import sys
            import tomllib
            from pathlib import Path

            config = os.path.expanduser("~/.config/mise/config.toml")
            with open(config, "rb") as f:
              data = tomllib.load(f)
            tools = data.get("tools", {})

            # Tool names and executable names do not always match 1:1.
            exe_candidates_map = {
              "aws-cli": ("aws",),
              "docker-cli": ("docker",),
              "gemini-cli": ("gemini", "gemini-cli"),
              "github-cli": ("gh",),
              "neovim": ("nvim",),
              "python": ("python3", "python"),
              "sqlite": ("sqlite3",),
              "uv": ("uv", "uvx"),
            }

            mise = os.path.expanduser("~/.local/bin/mise")
            missing_tools = []
            missing_commands = []
            for tool in sorted(tools.keys()):
              tool_exists = subprocess.run(
                [mise, "where", tool],
                capture_output=True,
                text=True,
              )
              if tool_exists.returncode != 0:
                missing_tools.append(tool)
                continue

              install_dir = tool_exists.stdout.strip()
              candidates = exe_candidates_map.get(tool, (tool,))
              found = False
              for exe in candidates:
                check = subprocess.run(
                  [mise, "exec", tool, "--", "bash", "-lc", f"command -v {shlex.quote(exe)}"],
                  capture_output=True,
                )
                if check.returncode == 0:
                  found = True
                  break

              # Some tools are installed under nested paths and are not
              # exposed via `mise exec ... command -v`.
              if not found:
                install_path = Path(install_dir)
                for exe in candidates:
                  if any(p.is_file() and os.access(p, os.X_OK) for p in install_path.rglob(exe)):
                    found = True
                    break

              if not found:
                missing_commands.append((tool, candidates, install_dir))

            if missing_tools:
              for tool in missing_tools:
                print(f"Missing mise tool install: {tool}", file=sys.stderr)
            if missing_commands:
              for tool, candidates, install_dir in missing_commands:
                print(
                  f"Missing executable for tool {tool}: expected one of {', '.join(repr(c) for c in candidates)} (install_dir={install_dir})",
                  file=sys.stderr,
                )
            if missing_tools or missing_commands:
              sys.exit(1)

            print(f"Checked {len(tools)} mise tools.")
            PY
